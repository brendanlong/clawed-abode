# Clawed Abode - Architecture Diagram

direction: right

# External clients
mobile: Mobile/Web Browser

# Tailscale
tailscale: Tailscale Funnel {
  style.fill: "#4A5568"
}

# Home Server
server: Home Server {
  style.fill: "#E8F4FD"

  app: Next.js + tRPC {
    style.fill: "#0070F3"
    style.font-color: white

    auth: Auth
    session_mgmt: Session Management
    agent_client: Agent Client (HTTP/SSE)
    websocket: WebSocket/SSE
  }

  podman: Podman Containers {
    style.fill: "#2496ED"
    style.font-color: white

    container1: Session Container {
      agent_svc: Agent Service (HTTP)
      claude_sdk: Claude Agent SDK
      workspace: Git Clone
      gpu: GPU Access
    }

    container2: Session Container {
      agent_svc2: Agent Service (HTTP)
      claude_sdk2: Claude Agent SDK
      workspace2: Git Clone
      gpu2: GPU Access
    }
  }

  storage: Storage {
    style.fill: "#4DB33D"
    style.font-color: white

    sqlite: SQLite {
      sessions: Sessions
      messages: Messages
      authSessions: AuthSessions
    }

    volumes: Named Volumes {
      workspaces: Workspace Volumes
      pnpm: pnpm Store
      gradle: Gradle Cache
      git_cache: Git Cache
    }
  }

  app.agent_client -> podman.container1.agent_svc: HTTP/SSE
  app.agent_client -> podman.container2.agent_svc2: HTTP/SSE
  app -> storage.sqlite: Prisma
  podman -> storage.volumes: mount
}

# Connections
mobile -> tailscale: HTTPS
tailscale -> server.app: Encrypted tunnel

# Data Model
data_model: Data Model {
  style.fill: "#FFF3CD"

  session: Session {
    shape: sql_table
    id: string {constraint: primary_key}
    name: string
    repoUrl: string
    branch: string
    workspacePath: string
    containerId: string | null
    agentPort: int | null
    status: enum
    statusMessage: string | null
    createdAt: timestamp
    updatedAt: timestamp
  }

  message: Message {
    shape: sql_table
    id: string {constraint: primary_key}
    sessionId: string {constraint: foreign_key}
    sequence: int
    type: enum
    content: jsonb
    createdAt: timestamp
  }

  authSession: AuthSession {
    shape: sql_table
    id: string {constraint: primary_key}
    token: string
    expiresAt: timestamp
    createdAt: timestamp
    ipAddress: string | null
    userAgent: string | null
  }

  session.id <- message.sessionId
}

# API Routes
api: tRPC API {
  style.fill: "#E9ECEF"

  auth_routes: auth {
    login: login()
    logout: logout()
    logoutAll: logoutAll()
    listSessions: listSessions()
    deleteSession: deleteSession()
  }

  session_routes: sessions {
    create: create()
    list: list()
    get: get()
    start: start()
    stop: stop()
    delete: delete()
  }

  claude_routes: claude {
    send: send() → Stream
    interrupt: interrupt()
    getHistory: getHistory()
  }

  github_routes: github {
    listRepos: listRepos()
    listBranches: listBranches()
  }
}

# Session Lifecycle
lifecycle: Session Lifecycle {
  style.fill: "#F8D7DA"
  direction: down

  creating: Creating {
    style.fill: "#FFC107"
  }
  running: Running {
    style.fill: "#28A745"
    style.font-color: white
  }
  stopped: Stopped {
    style.fill: "#6C757D"
    style.font-color: white
  }
  error: Error {
    style.fill: "#DC3545"
    style.font-color: white
  }

  creating -> running: Container + Agent ready
  running -> stopped: User stops
  stopped -> running: User starts
  running -> error: Failure
  creating -> error: Failure
}

# Agent Service Detail
agent_detail: Agent Service (per container) {
  style.fill: "#F0F4FF"
  direction: down

  http: HTTP Server {
    query: POST /query → SSE stream
    interrupt: POST /interrupt
    status: GET /status
    messages: GET /messages
    health: GET /health
  }

  sdk: Claude Agent SDK {
    query_fn: query()
    sessions: Session management
    resume: Resume support
  }

  msg_store: SQLite Message Store {
    append: append()
    get_after: getAfter()
  }

  http.query -> sdk.query_fn: Start query
  sdk.query_fn -> msg_store.append: Persist messages
  http.messages -> msg_store.get_after: Catch-up
}
